<?xml version="1.0" encoding="UTF-8"?>
<templates id="template" xml:space="preserve">

    <!-- Keep native Odoo receipt layout; append FE block only. -->
    <t t-inherit="point_of_sale.OrderReceipt" t-inherit-mode="extension">
        <xpath expr="//div[hasclass('pos-receipt')]" position="inside">
            <t t-set="data" t-value="(props &amp;&amp; (props.data || props.receipt || props.order_receipt || props.orderReceipt || props)) || {}"/>
            <t t-set="currentOrder" t-value="(props &amp;&amp; (props.order || props.currentOrder)) || null"/>
            <t t-set="company" t-value="(data &amp;&amp; (data.company || data.headerData)) || {}"/>
            <t t-set="einvoice" t-value="(data &amp;&amp; data.einvoice) || {}"/>
            <t t-set="partner" t-value="(data &amp;&amp; (data.partner || data.client)) || {}"/>

            <t t-set="orderlines" t-value="
                data.orderlines ||
                data.order_lines ||
                data.lines ||
                ((currentOrder &amp;&amp; currentOrder.get_orderlines &amp;&amp; currentOrder.get_orderlines()) || [])
            "/>

            <t t-set="paymentlines" t-value="
                data.paymentlines ||
                data.payment_lines ||
                ((currentOrder &amp;&amp; currentOrder.get_paymentlines &amp;&amp; currentOrder.get_paymentlines()) || [])
            "/>

            <t t-set="subtotal" t-value="
                (data.subtotal !== undefined &amp;&amp; data.subtotal !== null) ? data.subtotal :
                ((data.total_without_tax !== undefined &amp;&amp; data.total_without_tax !== null) ? data.total_without_tax :
                ((data.amount_untaxed !== undefined &amp;&amp; data.amount_untaxed !== null) ? data.amount_untaxed :
                ((currentOrder &amp;&amp; currentOrder.get_total_without_tax &amp;&amp; env.utils.formatCurrency(currentOrder.get_total_without_tax())) || '')))
            "/>

            <t t-set="tax" t-value="
                (data.tax !== undefined &amp;&amp; data.tax !== null) ? data.tax :
                ((data.total_tax !== undefined &amp;&amp; data.total_tax !== null) ? data.total_tax :
                ((data.amount_tax !== undefined &amp;&amp; data.amount_tax !== null) ? data.amount_tax :
                ((currentOrder &amp;&amp; currentOrder.get_total_tax &amp;&amp; env.utils.formatCurrency(currentOrder.get_total_tax())) || '')))
            "/>

            <t t-set="totalWithTax" t-value="
                (data.total_with_tax !== undefined &amp;&amp; data.total_with_tax !== null) ? data.total_with_tax :
                ((data.total !== undefined &amp;&amp; data.total !== null) ? data.total :
                ((data.amount_total !== undefined &amp;&amp; data.amount_total !== null) ? data.amount_total :
                ((currentOrder &amp;&amp; currentOrder.get_total_with_tax &amp;&amp; env.utils.formatCurrency(currentOrder.get_total_with_tax())) || '')))
            "/>

            <t t-set="discount_amount" t-value="
                (data.discount_amount !== undefined &amp;&amp; data.discount_amount !== null) ? data.discount_amount :
                ((data.total_discount !== undefined &amp;&amp; data.total_discount !== null) ? data.total_discount :
                ((data.discount_total !== undefined &amp;&amp; data.discount_total !== null) ? data.discount_total :
                ((currentOrder &amp;&amp; currentOrder.get_total_discount &amp;&amp; currentOrder.get_total_discount()) || 0)))
            "/>
            <t t-set="discount_amount" t-value="Math.abs(discount_amount || 0)"/>

            <div class="pos-receipt cr-fe-receipt">
                <!-- Company header -->
                <div class="cr-center cr-header">
                    <div class="cr-company-name">
                        <t t-esc="company.name || ''"/>
                    </div>
                    <t t-if="company.vat">
                        <div class="cr-small">Identificación <t t-esc="company.vat"/></div>
                    </t>
                    <t t-if="company.phone">
                        <div class="cr-small">Teléfono <t t-esc="company.phone"/></div>
                    </t>
                    <t t-if="company.email">
                        <div class="cr-small">Correo: <t t-esc="company.email"/></div>
                    </t>
                </div>

                <div class="cr-divider"/>

                <div class="cr-lines-head">
                    <div class="cr-col-qty"><strong>Cant</strong></div>
                    <div class="cr-col-desc"><strong>Descripción</strong></div>
                    <div class="cr-col-amt cr-right"><strong>Importe</strong></div>
                </div>
                <t t-foreach="orderlines" t-as="line" t-key="line_index">
                    <div class="cr-lines-row">
                        <div class="cr-col-qty"><t t-esc="line.qty || line.quantity || line.count || 0"/></div>
                        <div class="cr-col-desc"><t t-esc="line.product_name || line.full_product_name || line.name || ''"/></div>
                        <div class="cr-col-amt cr-right"><t t-esc="line.price_display || line.price_without_tax || line.price_subtotal || line.price_subtotal_excl || line.price || line.price_with_tax || line.price_subtotal_incl || ''"/></div>
                    </div>
                </t>

                <div class="cr-fe-extra">
                    <div class="cr-divider"/>

                    <t t-if="discount_amount &gt; 0">
                        <div class="cr-lines-row">
                            <div class="cr-col-qty"></div>
                            <div class="cr-col-desc"><strong>Descuento</strong></div>
                            <div class="cr-col-amt cr-right"><t t-esc="env.utils.formatCurrency(discount_amount)"/></div>
                        </div>
                    </t>

                    <div class="cr-center cr-doc-type">
                        <t t-set="dtype" t-value="einvoice.document_type || ''"/>
                        <strong>Tipo de comprobante:</strong>
                        <t t-if="dtype == 'te'"> Tiquete electrónico</t>
                        <t t-elif="dtype == 'fe'"> Factura electrónica</t>
                        <t t-elif="dtype == 'nc'"> Nota de crédito electrónica</t>
                        <t t-else=""> Comprobante</t>
                    </div>

                    <t t-set="consec" t-value="einvoice.consecutivo || ''"/>
                    <div class="cr-center cr-small">
                        <strong>Consecutivo:</strong>
                        <t t-if="consec">
                            <t t-esc="consec"/>
                        </t>
                        <t t-else="">Pendiente</t>
                    </div>

                    <div class="cr-block">
                        <div class="cr-title">Clave</div>
                        <t t-if="einvoice.clave">
                            <div class="cr-mono cr-wrap"><t t-esc="einvoice.clave"/></div>
                        </t>
                        <t t-else="">
                            <div class="cr-small">Pendiente</div>
                        </t>
                    </div>

                    <div class="cr-divider"/>
                    <div class="cr-center cr-small">
                        <t t-esc="(data.date &amp;&amp; data.date.localestring) || (data.date &amp;&amp; data.date) || ''"/>
                    </div>
                </div>

                <div style="text-align:center;margin-top:8px;" class="cr-fe-footer">
                    <div>Autorizado mediante la resolución MH-DGT-RES-0027-2024 del 13/11/2024 de la DGTD.</div>
                    <div>Version XML 4.4</div>
                </div>
            </div>
        </xpath>
    </t>

</templates>
