<?xml version="1.0" encoding="UTF-8"?>
<templates id="template" xml:space="preserve">

    <!-- Full receipt redesign for CR FE (TE/FE/NC) -->
    <t t-inherit="point_of_sale.OrderReceipt" t-inherit-mode="extension">
        <xpath expr="//div[contains(@class, 'pos-receipt')]" position="replace">
            <t t-set="data" t-value="(props &amp;&amp; (props.data || props.receipt || props.order_receipt || props.orderReceipt || props)) || {}"/>
            <t t-set="currentOrder" t-value="(props &amp;&amp; (props.order || props.currentOrder)) || null"/>
            <t t-set="company" t-value="data.company || data.headerData || {}"/>
            <t t-set="einvoice" t-value="data.einvoice || {}"/>
            <t t-set="partner" t-value="data.partner || data.client || {}"/>

            <t t-set="orderlines" t-value="
                data.orderlines ||
                data.order_lines ||
                data.lines ||
                ((currentOrder &amp;&amp; currentOrder.get_orderlines &amp;&amp; currentOrder.get_orderlines()) || [])
            "/>

            <t t-set="paymentlines" t-value="
                data.paymentlines ||
                data.payment_lines ||
                ((currentOrder &amp;&amp; currentOrder.get_paymentlines &amp;&amp; currentOrder.get_paymentlines()) || [])
            "/>

            <t t-set="subtotal" t-value="
                (data.subtotal !== undefined &amp;&amp; data.subtotal !== null) ? data.subtotal :
                ((data.total_without_tax !== undefined &amp;&amp; data.total_without_tax !== null) ? data.total_without_tax :
                ((data.amount_untaxed !== undefined &amp;&amp; data.amount_untaxed !== null) ? data.amount_untaxed :
                ((currentOrder &amp;&amp; currentOrder.get_total_without_tax &amp;&amp; env.utils.formatCurrency(currentOrder.get_total_without_tax())) || '')))
            "/>

            <t t-set="tax" t-value="
                (data.tax !== undefined &amp;&amp; data.tax !== null) ? data.tax :
                ((data.total_tax !== undefined &amp;&amp; data.total_tax !== null) ? data.total_tax :
                ((data.amount_tax !== undefined &amp;&amp; data.amount_tax !== null) ? data.amount_tax :
                ((currentOrder &amp;&amp; currentOrder.get_total_tax &amp;&amp; env.utils.formatCurrency(currentOrder.get_total_tax())) || '')))
            "/>

            <t t-set="totalWithTax" t-value="
                (data.total_with_tax !== undefined &amp;&amp; data.total_with_tax !== null) ? data.total_with_tax :
                ((data.total !== undefined &amp;&amp; data.total !== null) ? data.total :
                ((data.amount_total !== undefined &amp;&amp; data.amount_total !== null) ? data.amount_total :
                ((currentOrder &amp;&amp; currentOrder.get_total_with_tax &amp;&amp; env.utils.formatCurrency(currentOrder.get_total_with_tax())) || '')))
            "/>

            <div class="pos-receipt cr-fe-receipt">
                <!-- Company header -->
                <div class="cr-center cr-header">
                    <div class="cr-company-name">
                        <t t-esc="company.name || ''"/>
                    </div>
                    <t t-if="company.vat">
                        <div class="cr-small">Identificación <t t-esc="company.vat"/></div>
                    </t>
                    <t t-if="company.phone">
                        <div class="cr-small">Teléfono <t t-esc="company.phone"/></div>
                    </t>
                    <t t-if="company.email">
                        <div class="cr-small">Correo: <t t-esc="company.email"/></div>
                    </t>
                </div>

                <div class="cr-divider"/>

                <!-- Document type + consecutivo -->
                <div class="cr-center cr-doc">
                    <div class="cr-doc-type">
                        <t t-set="dtype" t-value="einvoice.document_type || ''"/>
                        <t t-if="dtype == 'te'">Tiquete electrónico</t>
                        <t t-elif="dtype == 'fe'">Factura electrónica</t>
                        <t t-elif="dtype == 'nc'">Nota de crédito electrónica</t>
                        <t t-else="">Comprobante</t>
                    </div>

                    <t t-set="consec" t-value="einvoice.consecutivo || ''"/>
                    <t t-if="consec">
                        <div class="cr-small">Consecutivo <t t-esc="consec"/></div>
                    </t>
                </div>

                <div class="cr-divider"/>

                <!-- Customer (Receptor) -->
                <div class="cr-block">
                    <div class="cr-title">Receptor</div>
                    <t t-if="partner &amp;&amp; partner.name">
                        <div><t t-esc="partner.name"/></div>
                    </t>
                    <t t-else="">
                        <div>Cliente general</div>
                    </t>

                    <t t-if="einvoice.receptor_id">
                        <div class="cr-small">Identificación <t t-esc="einvoice.receptor_id"/></div>
                    </t>
                </div>

                <div class="cr-divider"/>

                <!-- Order lines -->
                <div class="cr-lines">
                    <div class="cr-line cr-line-head">
                        <div class="cr-col-qty">Cant</div>
                        <div class="cr-col-prod">Producto</div>
                        <div class="cr-col-price">Precio</div>
                        <div class="cr-col-tax">Imp</div>
                        <div class="cr-col-total">Total</div>
                    </div>

                    <t t-foreach="orderlines" t-as="line" t-key="line.cid || line.id || line.product_name || line.product_id">
                        <div class="cr-line">
                            <div class="cr-col-qty"><t t-esc="line.quantity || line.qty || (line.get_quantity &amp;&amp; line.get_quantity()) || ''"/></div>
                            <div class="cr-col-prod">
                                <div><t t-esc="line.product_name || line.productName || line.name || (line.get_product &amp;&amp; line.get_product() &amp;&amp; line.get_product().display_name) || ''"/></div>
                                <t t-if="line.discount &amp;&amp; line.discount &gt; 0">
                                    <div class="cr-small">Desc: <t t-esc="line.discount"/>%</div>
                                </t>
                            </div>
                            <div class="cr-col-price"><t t-esc="line.price || line.price_display || line.unit_price || (line.get_unit_price &amp;&amp; env.utils.formatCurrency(line.get_unit_price())) || ''"/></div>
                            <div class="cr-col-tax">
                                <t t-if="line.tax_amount !== null &amp;&amp; line.tax_amount !== undefined">
                                    <t t-esc="env.utils.formatCurrency(line.tax_amount)"/>
                                </t>
                                <t t-elif="line.get_all_prices">
                                    <t t-set="p" t-value="line.get_all_prices()"/>
                                    <t t-esc="env.utils.formatCurrency((p &amp;&amp; p.tax) || 0)"/>
                                </t>
                                <t t-else="">
                                    <t t-esc="line.tax || line.price_tax || ''"/>
                                </t>
                            </div>
                            <div class="cr-col-total">
                                <t t-esc="line.total || line.price_with_tax || line.price_subtotal_incl || (line.get_all_prices &amp;&amp; env.utils.formatCurrency(line.get_all_prices().priceWithTax || 0)) || ''"/>
                            </div>
                        </div>
                    </t>
                </div>

                <div class="cr-divider"/>

                <!-- Totals -->
                <div class="cr-totals">
                    <div class="cr-row">
                        <div>Subtotal</div>
                        <div class="cr-right"><t t-esc="subtotal"/></div>
                    </div>
                    <div class="cr-row">
                        <div>Impuesto</div>
                        <div class="cr-right"><t t-esc="tax"/></div>
                    </div>
                    <div class="cr-row cr-strong">
                        <div>Total</div>
                        <div class="cr-right"><t t-esc="totalWithTax"/></div>
                    </div>
                </div>

                <div class="cr-divider"/>

                <!-- Payment methods -->
                <div class="cr-block">
                    <div class="cr-title">Medio de pago</div>
                    <t t-if="paymentlines &amp;&amp; paymentlines.length">
                        <t t-foreach="paymentlines" t-as="pl" t-key="pl.cid || pl.id || pl.name || pl.amount">
                            <div class="cr-row">
                                <div><t t-esc="pl.name || pl.payment_method || (pl.payment_method_id &amp;&amp; pl.payment_method_id.name) || ''"/></div>
                                <div class="cr-right"><t t-esc="(pl.amount !== undefined &amp;&amp; pl.amount !== null) ? pl.amount : (pl.amount_formatted || (pl.get_amount &amp;&amp; env.utils.formatCurrency(pl.get_amount())) || '')"/></div>
                            </div>
                        </t>
                    </t>
                    <t t-else="">
                        <div class="cr-small">N/A</div>
                    </t>
                </div>

                <div class="cr-divider"/>

                <!-- Clave -->
                <div class="cr-block">
                    <div class="cr-title">Clave</div>
                    <t t-set="clave" t-value="einvoice.clave || ''"/>
                    <t t-if="clave">
                        <div class="cr-mono cr-wrap"><t t-esc="clave"/></div>
                    </t>
                    <t t-else="">
                        <div class="cr-small">Pendiente</div>
                    </t>
                </div>

                <!-- Extra info -->
                <t t-if="einvoice.status">
                    <div class="cr-divider"/>
                    <div class="cr-center cr-small">
                        Estado FE: <t t-esc="einvoice.status"/>
                    </div>
                </t>

                <div class="cr-divider"/>
                <div class="cr-center cr-small">
                    <t t-esc="(data.date &amp;&amp; data.date.localestring) || ''"/>
                </div>
            </div>
        </xpath>
    </t>

</templates>
